addons:
  apt:
    packages:
    - dpkg

jobs:
  include:
    - stage: component test
      language: node_js
      node_js:
        - '10'

      sudo: true
      dist: xenial

      before_install:
      - cd ui

      before_script:
      - export CHROME_BIN=/usr/bin/google-chrome
      - export DISPLAY=:99.0
      - sh -e /etc/init.d/xvfb start
      - sudo apt-get update
      - sudo apt-get install -y libappindicator1 fonts-liberation
      - wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
      - sudo dpkg -i google-chrome*.deb

      script:
      - ng test --watch false
      - ng build --prod

    - stage: component test
      services:
      - postgresql
      dist: xenial
      env:
      - Database__ConnectionString="Host=localhost;Database=travis_ci_test;Username=postgres"
      language: csharp
      solution: hearts-backend.sln
      mono: none
      dotnet: 2.2.101
      before_install:
      - cd backend
      install:
      - dotnet restore
      before_script:
      - psql -c 'create database travis_ci_test;' -U postgres
      - dotnet ef database update --project HeartsApp
      script:
      - dotnet test
    - stage: Build
      dist: xenial
      language: csharp
      solution: hearts-backend.sln
      mono: none
      dotnet: 2.2.101
      before_install:
      - cp -r ui/dist/hearts-ui/* backend/HeartsApp/wwwroot
      - cd backend
      script:
      - dotnet publish -c Release      
    - stage: E2E
      services:
      - postgresql
      dist: xenial
      language: node_js
      node_js:
      - '10'
      env:
      - Database__ConnectionString="Host=localhost;Database=travis_ci_test;Username=postgres"
      sudo: true
      before_script:
      - export CHROME_BIN=/usr/bin/google-chrome
      - export DISPLAY=:99.0
      - sh -e /etc/init.d/xvfb start
      - cd backend/HeartsApp/bin/Release/netcoreapp2.2/publish
      - dotnet HeartsApp.dll &
      - sleep 10
      - cd ../../../../../../ui
      script:
      - npm run e2e-local
    

